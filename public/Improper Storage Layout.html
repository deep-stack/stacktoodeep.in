<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Improper Storage Layout</title>
  <link rel="stylesheet" href="reset.css" />
  <link rel="stylesheet" href="index.css" />
  <style>
    .title {
      text-align: left;
      font-size: 2em;
      margin-bottom: 0;
    }
    .subtitle {
      text-align: left;
      font-size: 1em;
      color: #555;
      margin-top: 0;
    }
  </style>
</head>
<body>
<table class="header">
  <tr>
    <td colspan="2" class="width-auto">
      <h1 class="title">Improper Storage Layout</h1>
    </td>
  </tr>
  <tr>
    <th class="width-min">Organization</th>
    <td class="width-auto">DeepStack Software Pvt. Ltd.</td>
  </tr>
  <tr>
    <th class="width-min">Org URL</th>
    <td class="width-auto"><a href="https://www.deepstacksoft.com">https://www.deepstacksoft.com</a></td>
  </tr>
  </tr>
</table>
<nav id="TOC" role="doc-toc">
      <h2 id="toc-title">Contents</h2>
    <ul class="incremental">
    <li><a href="#introduction" id="toc-introduction">Introduction</a>
    <ul class="incremental">
    <li><a href="#storage-collision-between-proxy-and-implementation"
    id="toc-storage-collision-between-proxy-and-implementation">Storage
    Collision Between Proxy and Implementation</a></li>
    <li><a href="#storage-collision-between-implementation-versions"
    id="toc-storage-collision-between-implementation-versions">Storage
    Collision Between Implementation Versions</a></li>
    </ul></li>
    <li><a href="#mitigation" id="toc-mitigation">Mitigation</a></li>
    </ul>
</nav>
<nav>
<a href="index.html"><button>Back</button></a>
</nav>
<p><strong>Posted on: 2024-09-18</strong></p>
<h2 id="introduction">Introduction</h2>
<p>One common problem that arises when using <a
href="https://medium.com/@social_42205/proxy-contracts-in-solidity-f6f5ffe999bd">proxies</a>
is storage collision. This occurs when the implementation contract reads
from or writes to a storage variable that occupies a different slot in
the proxy contract than it does in the implementation contract.<br></p>
<h3 id="storage-collision-between-proxy-and-implementation">Storage
Collision Between Proxy and Implementation</h3>
<p><img src="codeblock-7.png" /> <img src="codeblock-8.png" /> <img
src="codeblock-9.png" /></p>
<h3 id="storage-collision-between-implementation-versions">Storage
Collision Between Implementation Versions</h3>
<p>Storage collisions can also occur between different versions of an
implementation contract<br> <img src="codeblock-10.png" /></p>
<h2 id="mitigation">Mitigation</h2>
<p>To avoid storage collisions, instead of storing the implementation
address at the first storage slot of the proxy, a pseudo-random slot is
chosen using EIP-1967<br> <img src="codeblock-11.png" /></p>
<p>When extending the storage layout, it is crucial to append new
variables rather than inserting or deleting them from between existing
ones. This approach ensures that the layouts remain completely
independent and do not interfere with each otherâ€™s variable
locations.</p>
  <script src="index.js"></script>
</body>
</html>
